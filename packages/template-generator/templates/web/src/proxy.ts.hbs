import {
  convexAuthNextjsProxy,
  createRouteMatcher,
  nextjsProxyRedirect,
} from '@convex-dev/auth/nextjs/server'

const isPublicRoute = createRouteMatcher(['/sign-in', '/sign-up'])

export default convexAuthNextjsProxy(async (request, { convexAuth }) => {
  const isAuthenticated = await convexAuth.isAuthenticated()

  // Redirect unauthenticated users to /sign-up
  if (!isPublicRoute(request) && !isAuthenticated) {
    return nextjsProxyRedirect(request, '/sign-up')
  }

  // Redirect authenticated users from auth pages to / (dashboard)
  if (isPublicRoute(request) && isAuthenticated) {
    return nextjsProxyRedirect(request, '/')
  }
})
