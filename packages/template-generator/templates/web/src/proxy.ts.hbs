import {
  convexAuthNextjsMiddleware,
  createRouteMatcher,
  nextjsMiddlewareRedirect,
} from '@convex-dev/auth/nextjs/server'

const isPublicRoute = createRouteMatcher(['/sign-in', '/sign-up'])

// Next.js 16 uses proxy.ts (renamed from middleware.ts)
// @convex-dev/auth still uses "middleware" naming in exports
export default convexAuthNextjsMiddleware(async (request, { convexAuth }) => {
  const isAuthenticated = await convexAuth.isAuthenticated()

  // Redirect unauthenticated users to /sign-up
  if (!isPublicRoute(request) && !isAuthenticated) {
    return nextjsMiddlewareRedirect(request, '/sign-up')
  }

  // Redirect authenticated users from auth pages to / (dashboard)
  if (isPublicRoute(request) && isAuthenticated) {
    return nextjsMiddlewareRedirect(request, '/')
  }
})

export const config = {
  matcher: ['/((?!.*\\..*|_next).*)', '/', '/(api|trpc)(.*)'],
}
